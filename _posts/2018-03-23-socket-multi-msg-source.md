---
layout: post
title: "在单条流式tcp socket中实现多路并发请求的代理转发"
tags: [网络编程, tcp, golang]
comments: true
date: 2018-03-25 09:00:00+08:00
---

#### 问题描述
因为业务原因，需要在客户端能够代理服务器转发过去基于tcp协议的请求，用的socks5封装。那么就会产生一些问题，如下:
1. 多请求并发的问题。传统情况下，一个请求对应着client和server端的 ip:port 两个socket，即一条socket，那么在一条socket的情况下，如何实现多请求的并发
2. 众所周知，tcp是流式的数据传输，没有明确的头尾标识，也没有固定的包长大小，因此，在client或者server端如何能够准确的识别到对方一次的write内容
3. 客户端在拿到多个并发请求的时候，如何构建线程模型进行处理，减小消耗（以后章节会介绍）


#### 解决方案
1. 利用高层协议模拟底层协议的思想，为一次请求分配一个requestID，模拟tcp协议头中的端口的概念进行请求的标识
2. 客户端和服务器模仿socks5协议约定了一个新的协议，以下简称新协议。在新协议中，服务器和客户端都需要在写操作（write）中，添加上新协议头，在新协议头中设置读取标识位、requestID和正文的长度位，解决了包体头尾的读取问题
3. 客户端从BIO模式的线程池迭代到NIO或者Netty


#### 具体解决